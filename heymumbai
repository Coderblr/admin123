import { useState } from "react";
import { styles } from "../../styles/AppStyles";

export default function PanCifView() {
    const [region, setRegion] = useState("O");
    const [acc_type, setAccountType] = useState("PCIF");
    const [firstname, setFirstName] = useState("");
    const [lastname, setLastName] = useState("");
    const [pancard, setPan] = useState("");
    const [mobile_no, setMobile] = useState("");
    const [response, setResponse] = useState([]);
    const [error, setError] = useState("");
    const [Loading, setLoading] = useState(false);

    async function handleSubmit(e) {
        e.preventDefault();

        const errors = {};

        // ✅ First Name validation
        if (!/^[A-Za-z]+$/.test(firstname)) {
            errors.name = "First Name should contain only alphabets";
        }

        // ✅ Last Name validation
        if (!/^[A-Za-z]+$/.test(lastname)) {
            errors.name = "Last Name should contain only alphabets";
        }

        // ✅ PAN format check
        if (!/^[A-Z]{5}\d{4}[A-Z]$/.test(pancard)) {
            errors.pan = "Invalid PAN format";
        }

        // ✅ 4th character must be P
        if (pancard && pancard[3] !== "P") {
            errors.pan = "4th character of PAN must be 'P'";
        }

        // ✅ 5th character must match last name initial
        if (lastname && pancard && pancard[4] !== lastname[0].toUpperCase()) {
            errors.pan = "PAN 5th character must match last name initial";
        }

        // ❌ Stop submit if any error
        if (Object.keys(errors).length > 0) {
            setError(errors.name || errors.pan);
            return;
        }

        setLoading(true);
        setError("");
        setResponse([]);

        const userToken = localStorage.getItem("userToken");

        try {
            const res = await fetch(
                "http://10.1.1545761.165654:505687880/create_first_cif/",
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${userToken}`,
                    },
                    body: JSON.stringify({
                        region,
                        acc_type,
                        firstname,
                        lastname,
                        pancard,
                        mobile_no,
                    }),
                }
            );

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.detail || "Failed to generate CIF");
            }

            const data = await res.json();
            setResponse(data);
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    }

    return (
        <div>
            <div style={styles.pageHeader}>
                <h1 style={styles.pageTitle}>CIF Creation</h1>
                <p style={styles.pageSubtitle}>
                    Generate Customer Information Files for testing
                </p>
            </div>

            <div style={styles.formCard}>
                <div style={styles.formGrid}>
                    {/* Region */}
                    <div style={styles.formGroup}>
                        <label style={styles.label}>Region</label>
                        <select
                            value={region}
                            onChange={(e) => setRegion(e.target.value)}
                            style={styles.select}
                        >
                            <option value="O">O - UAT</option>
                            <option value="X">X - UAT</option>
                            <option value="Y">Y - UAT</option>
                        </select>
                    </div>

                    {/* Account Type */}
                    <div style={styles.formGroup}>
                        <label style={styles.label}>Account Type</label>
                        <select
                            value={acc_type}
                            onChange={(e) => setAccountType(e.target.value)}
                            style={styles.select}
                        >
                            <option value="PCIF">Personal CIF</option>
                            <option value="NPCIF">Non-Personal CIF</option>
                        </select>
                    </div>

                    {/* First Name */}
                    <div style={styles.formGroup}>
                        <label style={styles.label}>First Name</label>
                        <input
                            type="text"
                            value={firstname}
                            onChange={(e) => {
                                const value = e.target.value;
                                if (!/^[A-Za-z]*$/.test(value)) {
                                    alert("Only alphabets allowed in First Name");
                                    return;
                                }
                                setFirstName(value);
                            }}
                            style={styles.input}
                            required
                        />
                    </div>

                    {/* Last Name */}
                    <div style={styles.formGroup}>
                        <label style={styles.label}>Last Name</label>
                        <input
                            type="text"
                            value={lastname}
                            onChange={(e) => {
                                const value = e.target.value;
                                if (!/^[A-Za-z]*$/.test(value)) {
                                    alert("Only alphabets allowed in Last Name");
                                    return;
                                }
                                setLastName(value);
                            }}
                            style={styles.input}
                            required
                        />
                    </div>

                    {/* PAN */}
                    <div style={styles.formGroup}>
                        <label style={styles.label}>PAN Number</label>
                        <input
                            type="text"
                            value={pancard}
                            onChange={(e) => {
                                let value = e.target.value.toUpperCase();
                                if (value.length > 10) return;

                                if (value.length <= 5 && !/^[A-Z]*$/.test(value)) return;
                                if (value.length > 5 && value.length <= 9 && !/^[A-Z]{5}\d*$/.test(value)) return;
                                if (value.length >= 4 && value[3] !== "P") return;
                                if (value.length >= 5 && lastname && value[4] !== lastname[0]?.toUpperCase()) return;

                                setPan(value);
                            }}
                            style={styles.input}
                            maxLength={10}
                            required
                        />
                    </div>

                    {/* Mobile */}
                    <div style={styles.formGroup}>
                        <label style={styles.label}>Mobile Number</label>
                        <input
                            type="text"
                            value={mobile_no}
                            onChange={(e) => {
                                const value = e.target.value;
                                if (!/^\d*$/.test(value)) return;
                                if (value.length > 10) return;
                                setMobile(value);
                            }}
                            style={styles.input}
                            maxLength={10}
                            required
                        />
                    </div>
                </div>

                {error && <div style={styles.errorMsg}>{error}</div>}

                <button
                    onClick={handleSubmit}
                    style={styles.primaryButton}
                    disabled={Loading}
                >
                    {Loading ? "Generating..." : "Generate CIF Records"}
                </button>
            </div>
        </div>
    );
}
